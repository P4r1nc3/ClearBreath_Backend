<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Green Breath - Map</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }

        span {
            color: #2091d6;
        }

        #map {
            width: 100%;
            height: calc(100% - 56px)
        }

        .close:focus {
            outline: none;
        }

        #togglePanelBtn {
            position: fixed;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            z-index: 1001;
            background-color: #ffffff;
            color: #000000;
            border: none;
            padding: 30px 10px;
            cursor: pointer;
            transition: left 0.3s ease-in-out;
            border-radius: 0 10px 10px 0;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
        }

        #markerInfoPanel {
            position: fixed;
            top: 56px;
            left: -400px;
            width: 400px;
            height: calc(100% - 56px);
            background-color: white;
            overflow-y: auto;
            transition: left 0.3s ease-in-out;
            z-index: 1000;
            box-shadow: 10px 10px 10px rgba(0, 0, 0, 0.1);
            opacity: 95%;
        }

        .marker-info-header {
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;

        }

        .marker-info-content {
            padding: 20px;
            padding-bottom: 60px;
        }

        .marker-info-footer {
            padding: 10px;
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            position: fixed;
            width: 400px;
            bottom: 0;
            background-color: white;
            z-index: 1001;
        }

        #arrowIcon {
            transition: transform 0.3s ease-in-out;
        }

        #togglePanelBtn.active #arrowIcon {
            transform: rotate(180deg);
        }
    </style>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
</head>

<body>
    <!-- navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <a class="navbar-brand" href="index.html"><span>Green</span>Breath</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
            <ul class="navbar-nav" id="navButtons">
                <!-- Dynamic buttons will be added here based on login status -->
            </ul>
        </div>
    </nav>

    <!-- map -->
    <div id="map"></div>

    <!-- marker info div -->
    <div id="markerInfoPanel" class="marker-info-panel">
        <div class="marker-info-header">
            <h5>Marker Details</h5>
            <button type="button" class="close" aria-label="Close">
                <span aria-hidden="true" onclick="toggleMarkerInfoPanel()" >&times;</span>
            </button>
        </div>
        <div class="marker-info-content" id="markerInfoContent">
        </div>
        <div class="marker-info-footer">
            <button class="btn btn-danger" id="deleteMarkerBtn">Remove Marker</button>
        </div>
        <button class="btn btn-primary" id="togglePanelBtn" onclick="toggleMarkerInfoPanel()">
            <span><i id="arrowIcon" class="fas fa-caret-right"></i></span>
        </button>
    </div>

    <script>
        var map = L.map('map', {
            zoomControl: false,
            minZoom: 3,
        }).setView([20, 0], 3);

        var southWest = L.latLng(-90, -Infinity);
        var northEast = L.latLng(90, Infinity);
        var bounds = L.latLngBounds(southWest, northEast);

        map.setMaxBounds(bounds);
        map.on('drag', function() {
            map.panInsideBounds(bounds, { animate: false });
        });

        var markers = [];
        var clickedMarker = null;
        var chart;

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© GreenBreath'
        }).addTo(map);

        L.control.zoom({
            position: 'bottomright'
        }).addTo(map);

        map.on('click', function (e) {
            var lat = e.latlng.lat;
            var lng = e.latlng.lng;
            addMarker(lat, lng);
            savePointToDatabase(lat, lng);
        });

        function addMarker(lat, lng) {
            var marker = L.marker([lat, lng]).addTo(map);
            markers.push(marker);

            marker.on('click', function (e) {
                var markerCoord = e.latlng;
                clickedMarker = markerCoord;

                $('#markerInfoContent').html(`
            <p>Lat: ${markerCoord.lat}</p>
            <p>Lng: ${markerCoord.lng}</p>
        `);

                sendPollutionRequest(markerCoord.lat, markerCoord.lng);

                if (chart) {
                    chart.destroy();
                    chart = null;
                }
                
                $('#deleteMarkerBtn').on('click', function () {
                    if (clickedMarker) {
                        var index = markers.findIndex(m => m.getLatLng().equals(clickedMarker));

                        if (index !== -1) {
                            map.removeLayer(markers[index]);
                            markers.splice(index, 1);
                            deletePointFromDatabase(clickedMarker.lat, clickedMarker.lng);
                            $('#markerInfoModal').modal('hide');
                            clickedMarker = null;
                        } else {
                            console.warn("Marker not found in the markers array.");
                        }
                    } else {
                        console.warn("No marker clicked.");
                    }
                });
                if ($('#togglePanelBtn').hasClass('active')) {
                    openMarkerInfoPanel();
                } else {
                    toggleMarkerInfoPanel();
                }
            });
        }

        function sendPollutionRequest(lat, lng) {
            var xhrPollution = new XMLHttpRequest();
            xhrPollution.onreadystatechange = function () {
                if (xhrPollution.readyState === 4) {
                    if (xhrPollution.status === 200) {
                        var pollutionData = JSON.parse(xhrPollution.responseText);
                        createPollutionChart(pollutionData);
                    } else {
                        console.error("Error sending pollution request. Status:", xhrPollution.status);
                    }
                }
            };
            var urlPollution = "http://localhost:8080/pollution?lat=" + lat + "&lng=" + lng;
            xhrPollution.open("GET", urlPollution, true);
            xhrPollution.send();
        }

        function createPollutionChart(pollutionData) {
            createSubChart('pm25Chart', 'PM 2.5 Pollution Data', 'rgba(75, 192, 192, 0.2)', 'rgba(75, 192, 192, 1)', pollutionData.data.forecast.daily.pm25);
            createSubChart('pm10Chart', 'PM 10 Pollution Data', 'rgba(255, 99, 132, 0.2)', 'rgba(255, 99, 132, 1)', pollutionData.data.forecast.daily.pm10);
            createSubChart('o3Chart', 'O3 Pollution Data', 'rgba(54, 162, 235, 0.2)', 'rgba(54, 162, 235, 1)', pollutionData.data.forecast.daily.o3);
        }

        function createSubChart(canvasId, label, backgroundColor, borderColor, data) {
            var ctx = document.createElement('canvas');
            ctx.id = canvasId;
            document.getElementById('markerInfoContent').appendChild(ctx);

            var subChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(day => day.day),
                    datasets: [{
                        label: label,
                        data: data.map(day => day.avg),
                        backgroundColor: backgroundColor,
                        borderColor: borderColor,
                        borderWidth: 1
                    }]
                },
                options: {
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function loadMarkers() {
            var token = localStorage.getItem('token');
            var xhrLoadMarkers = new XMLHttpRequest();
            xhrLoadMarkers.onreadystatechange = function () {
                if (xhrLoadMarkers.readyState == 4) {
                    if (xhrLoadMarkers.status == 200) {
                        var markerData = JSON.parse(xhrLoadMarkers.responseText);
                        markerData.forEach(function (data) {
                            addMarker(data.lat, data.lng);
                        });
                    } else {
                        console.error("Failed to load markers from the database!");
                    }
                }
            };
            var urlLoadMarkers = "http://localhost:8080/markers/all";
            xhrLoadMarkers.open("GET", urlLoadMarkers, true);
            xhrLoadMarkers.setRequestHeader('Authorization', 'Bearer ' + token)
            xhrLoadMarkers.send();
        }

        function savePointToDatabase(lat, lng) {
            var token = localStorage.getItem('token');
            var xhrSavePoint = new XMLHttpRequest();
            xhrSavePoint.onreadystatechange = function () {
                if (xhrSavePoint.readyState == 4) {
                    if (xhrSavePoint.status == 200) {
                        console.log("Point saved to the database successfully!");
                    } else {
                        console.error("Failed to save point to the database!");
                    }
                }
            };
            var urlSavePoint = "http://localhost:8080/markers?lat=" + lat + "&lng=" + lng;
            xhrSavePoint.open("POST", urlSavePoint, true);
            xhrSavePoint.setRequestHeader('Authorization', 'Bearer ' + token);
            xhrSavePoint.send();
        }

        function deletePointFromDatabase(lat, lng) {
            var token = localStorage.getItem('token');
            var xhrDeletePoint = new XMLHttpRequest();
            xhrDeletePoint.onreadystatechange = function () {
                if (xhrDeletePoint.readyState == 4) {
                    if (xhrDeletePoint.status == 200) {
                        console.log("Point deleted from the database successfully!");
                    } else {
                        console.error("Failed to delete point from the database!");
                    }
                }
            };
            var urlDeletePoint = "http://localhost:8080/markers?lat=" + lat + "&lng=" + lng;
            xhrDeletePoint.open("DELETE", urlDeletePoint, true);
            xhrDeletePoint.setRequestHeader('Authorization', 'Bearer ' + token);
            xhrDeletePoint.send();
        }

        $(document).ready(function () {
            loadMarkers();
        });

        document.addEventListener('DOMContentLoaded', function () {
            var loggedIn = localStorage.getItem('token') ? true : false;
            function updateNavButtons() {
                var navButtons = document.getElementById("navButtons");
                if (loggedIn) {
                    navButtons.innerHTML = '<li class="nav-item"><a class="nav-link" href="map.html">Map</a></li>' +
                        '<li class="nav-item"><a class="nav-link" href="#" id="logoutBtn">Logout</a></li>';
                } else {
                    navButtons.innerHTML = '<li class="nav-item"><a class="nav-link" href="signIn.html">SignIn</a></li>' +
                        '<li class="nav-item"><a class="nav-link" href="signUp.html">SignUp</a></li>';
                }
            }
            updateNavButtons();
            document.getElementById('navButtons').addEventListener('click', function (event) {
                if (event.target.id === 'logoutBtn') {
                    localStorage.removeItem('token');
                    loggedIn = false;
                    updateNavButtons();
                    alert('Logout successful!');
                    window.location.href = 'index.html';
                }
            });
        });

        function toggleMarkerInfoPanel() {
            var panel = document.getElementById('markerInfoPanel');
            var button = document.getElementById('togglePanelBtn');
            var isOpen = panel.style.left === '0px';

            if (isOpen) {
                closeMarkerInfoPanel();
                button.style.left = '0';
                button.classList.remove('active');
            } else {
                openMarkerInfoPanel();
                button.style.left = '400px';
                button.classList.add('active');
            }
        }

        function openMarkerInfoPanel() {
            document.getElementById('markerInfoPanel').style.left = '0';
        }

        function closeMarkerInfoPanel() {
            document.getElementById('markerInfoPanel').style.left = '-400px';
        }
    </script>
</body>
</html>
